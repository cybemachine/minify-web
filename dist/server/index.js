"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const http_1 = require("http");
const logger_1 = tslib_1.__importDefault(require("../logger"));
const handler_1 = tslib_1.__importDefault(require("./handler"));
const fs_1 = require("fs");
const timers_1 = require("timers");
findroutes();
const server = new http_1.Server();
const logger = new logger_1.default();
const routes = [];
server.on("request", (requ, resu) => {
    const { req, res } = handler_1.default(requ, resu);
    router(req, res);
});
timers_1.setInterval(findroutes, 10 * 1000);
function findroutes() {
    fs_1.readdirSync(`${__dirname}/routes`)
        .filter(e => e.endsWith('.js'))
        .forEach(f => {
        const mod = require(`./routes/${f}`);
        routes.push(mod.__esModule ? mod.default : mod);
    });
}
function router(req, res, i = 0) {
    let mod = routes[i];
    const url = new URL(String(req.url), 'http://localhost').pathname;
    if (!mod) {
        res.statusCode = 404;
        res.statusMessage = 'Not Found';
        console.log(`${req.method} ${req.url}`, mod);
        return res.end('404');
    }
    const runmod = () => {
        console.log(`${req.method} ${req.url}`, mod);
        if (mod.handler)
            return mod.handler(req, res);
        if (mod.handlerAsync)
            return mod.handlerAsync(req, res);
        throw new TypeError(`${mod.startswith} has no handler`);
    };
    if (mod.path && url == mod.path)
        return runmod();
    if (mod.endswith && url.endsWith(mod.endswith))
        return runmod();
    if (mod.startswith && url.startsWith(mod.startswith))
        return runmod();
    router(req, res, i + 1);
}
exports.default = server;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9wYWNrYWdlcy9zZXJ2ZXIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQThCO0FBQzlCLCtEQUErQjtBQUMvQixnRUFBZ0M7QUFDaEMsMkJBQWlDO0FBRWpDLG1DQUFxQztBQUdyQyxVQUFVLEVBQUUsQ0FBQztBQUNiLE1BQU0sTUFBTSxHQUFHLElBQUksYUFBTSxFQUFFLENBQUM7QUFDNUIsTUFBTSxNQUFNLEdBQUcsSUFBSSxnQkFBTSxFQUFFLENBQUM7QUFDNUIsTUFBTSxNQUFNLEdBQWMsRUFBRSxDQUFDO0FBRTdCLE1BQU0sQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFO0lBQ2hDLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsaUJBQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDeEMsTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUNyQixDQUFDLENBQUMsQ0FBQztBQUVILG9CQUFXLENBQUMsVUFBVSxFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQTtBQUVsQyxTQUFTLFVBQVU7SUFDZixnQkFBVyxDQUFDLEdBQUcsU0FBUyxTQUFTLENBQUM7U0FDN0IsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM5QixPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDVCxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQ3BDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDcEQsQ0FBQyxDQUFDLENBQUE7QUFDVixDQUFDO0FBRUQsU0FBUyxNQUFNLENBQUMsR0FBUSxFQUFFLEdBQVEsRUFBRSxDQUFDLEdBQUcsQ0FBQztJQUNyQyxJQUFJLEdBQUcsR0FBZSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDaEMsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDLFFBQVEsQ0FBQztJQUVsRSxJQUFJLENBQUMsR0FBRyxFQUFFO1FBQ04sR0FBRyxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUM7UUFDckIsR0FBRyxDQUFDLGFBQWEsR0FBRyxXQUFXLENBQUM7UUFDaEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLElBQUksR0FBRyxDQUFDLEdBQUcsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzdDLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztLQUN6QjtJQUVELE1BQU0sTUFBTSxHQUFHLEdBQUcsRUFBRTtRQUNoQixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDN0MsSUFBSSxHQUFHLENBQUMsT0FBTztZQUFFLE9BQU8sR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDOUMsSUFBSSxHQUFHLENBQUMsWUFBWTtZQUFFLE9BQU8sR0FBRyxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDeEQsTUFBTSxJQUFJLFNBQVMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxVQUFVLGlCQUFpQixDQUFDLENBQUM7SUFDNUQsQ0FBQyxDQUFBO0lBRUQsSUFBSSxHQUFHLENBQUMsSUFBSSxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsSUFBSTtRQUFFLE9BQU8sTUFBTSxFQUFFLENBQUE7SUFDaEQsSUFBSSxHQUFHLENBQUMsUUFBUSxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQztRQUFFLE9BQU8sTUFBTSxFQUFFLENBQUE7SUFDL0QsSUFBSSxHQUFHLENBQUMsVUFBVSxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQztRQUFFLE9BQU8sTUFBTSxFQUFFLENBQUE7SUFFckUsTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQzVCLENBQUM7QUFFRCxrQkFBZSxNQUFNLENBQUMifQ==